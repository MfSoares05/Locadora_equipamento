<?php
// PHP code for equipment rental system with inventory management and reports
// Save as index.php and run on a server with PHP and MySQL
// Assumes database is created as per previous SQL schema

// Database connection
$host = 'localhost';
$dbname = 'locadora_equipamentos';
$user = 'root'; // Your MySQL user
$pass = ''; // Your MySQL password

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Connection failed: " . $e->getMessage());
}

// Function to hash password
function hashPassword($password) {
    return password_hash($password, PASSWORD_DEFAULT);
}

// Function to verify password
function verifyPassword($password, $hash) {
    return password_verify($password, $hash);
}

// Handle user registration
if (isset($_POST['register'])) {
    $username = $_POST['username'];
    $password = hashPassword($_POST['password']);
    
    $stmt = $pdo->prepare("INSERT INTO users (username, password) VALUES (?, ?)");
    $stmt->execute([$username, $password]);
    echo "User registered!";
}

// Handle login
session_start();
if (isset($_POST['login'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];
    
    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
    $stmt->execute([$username]);
    $user = $stmt->fetch();
    
    if ($user && verifyPassword($password, $user['password'])) {
        $_SESSION['user_id'] = $user['id'];
        echo "Logged in!";
    } else {
        echo "Invalid credentials!";
    }
}

// Require login
if (!isset($_SESSION['user_id'])) {
    ?>
    <form method="POST">
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit" name="login">Login</button>
    </form>
    <?php
    exit;
}

// Handle adding equipment
if (isset($_POST['add_equipment'])) {
    $name = $_POST['equipment_name'];
    $stock = $_POST['equipment_stock'];
    $stmt = $pdo->prepare("INSERT INTO equipments (name, stock) VALUES (?, ?)");
    $stmt->execute([$name, $stock]);
    echo "Equipment added!";
}

// Handle removing equipment
if (isset($_POST['remove_equipment'])) {
    $id = $_POST['equipment_id'];
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM rentals WHERE equipment_id = ? AND status = 'active'");
    $stmt->execute([$id]);
    if ($stmt->fetchColumn() == 0) {
        $stmt = $pdo->prepare("DELETE FROM equipments WHERE id = ?");
        $stmt->execute([$id]);
        echo "Equipment removed!";
    } else {
        echo "Cannot remove: Equipment is in active rentals!";
    }
}

// Handle updating stock
if (isset($_POST['update_stock'])) {
    $id = $_POST['equipment_id'];
    $stock = $_POST['new_stock'];
    $stmt = $pdo->prepare("UPDATE equipments SET stock = ? WHERE id = ?");
    $stmt->execute([$stock, $id]);
    echo "Stock updated!";
}

// Handle adding client
if (isset($_POST['add_client'])) {
    $name = $_POST['client_name'];
    $cpf = $_POST['client_cpf'];
    $address = $_POST['client_address'];
    
    $stmt = $pdo->prepare("INSERT INTO clients (name, cpf, address) VALUES (?, ?, ?)");
    $stmt->execute([$name, $cpf, $address]);
    echo "Client added!";
}

// Handle creating rental
if (isset($_POST['create_rental'])) {
    $client_id = $_POST['client_id'];
    $equipment_id = $_POST['equipment_id'];
    $quantity = $_POST['quantity'];
    $value = $_POST['value'];
    $start_date = $_POST['start_date'];
    $end_date = $_POST['end_date'];
    
    // Check available stock
    $stmt = $pdo->prepare("SELECT stock FROM equipments WHERE id = ?");
    $stmt->execute([$equipment_id]);
    $available_stock = $stmt->fetchColumn();
    
    if ($available_stock >= $quantity) {
        // Update stock
        $stmt = $pdo->prepare("UPDATE equipments SET stock = stock - ? WHERE id = ?");
        $stmt->execute([$quantity, $equipment_id]);
        
        // Save rental
        $stmt = $pdo->prepare("INSERT INTO rentals (client_id, equipment_id, quantity, value, start_date, end_date, status) VALUES (?, ?, ?, ?, ?, ?, 'active')");
        $stmt->execute([$client_id, $equipment_id, $quantity, $value, $start_date, $end_date]);
        echo "Rental saved!";
        ?>
        <a href="https://www.nfse.gov.br/EmissorNacional/Login?ReturnUrl=%2fEmissorNacional">EMITIR NF</a>
        <?php
    } else {
        echo "Insufficient stock! Available: $available_stock";
    }
}

// Handle completing rental
if (isset($_POST['complete_rental'])) {
    $rental_id = $_POST['rental_id'];
    $equipment_id = $_POST['equipment_id'];
    $quantity = $_POST['quantity'];
    
    // Update rental status
    $stmt = $pdo->prepare("UPDATE rentals SET status = 'completed' WHERE id = ?");
    $stmt->execute([$rental_id]);
    
    // Return quantity to stock
    $stmt = $pdo->prepare("UPDATE equipments SET stock = stock + ? WHERE id = ?");
    $stmt->execute([$quantity, $equipment_id]);
    echo "Rental completed and stock updated!";
}

// Fetch data for forms and reports
$equipments = $pdo->query("SELECT * FROM equipments")->fetchAll();
$clients = $pdo->query("SELECT * FROM clients")->fetchAll();
$rentals = $pdo->query("SELECT r.*, e.name AS equipment_name, c.name AS client_name FROM rentals r JOIN equipments e ON r.equipment_id = e.id JOIN clients c ON r.client_id = c.id WHERE r.status = 'active'")->fetchAll();
$all_rentals = $pdo->query("SELECT r.*, e.name AS equipment_name, c.name AS client_name FROM rentals r JOIN equipments e ON r.equipment_id = e.id JOIN clients c ON r.client_id = c.id")->fetchAll();
$low_stock = $pdo->query("SELECT * FROM equipments WHERE stock < 5")->fetchAll(); // Low stock threshold: 5

?>

<!DOCTYPE html>
<html>
<head>
    <title>Equipment Rental System</title>
    <style>
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        h2 { margin-top: 20px; }
        form { margin-bottom: 20px; }
        input, select, textarea, button { margin: 5px; }
    </style>
</head>
<body>

<!-- Current Stock Report -->
<h2>Current Stock Report</h2>
<table>
    <tr><th>Equipment</th><th>Stock</th></tr>
    <?php foreach ($equipments as $eq): ?>
        <tr><td><?= $eq['name'] ?></td><td><?= $eq['stock'] ?></td></tr>
    <?php endforeach; ?>
</table>

<!-- Low Stock Report -->
<h2>Low Stock Report (Stock < 5)</h2>
<table>
    <tr><th>Equipment</th><th>Stock</th></tr>
    <?php if (count($low_stock) > 0): ?>
        <?php foreach ($low_stock as $eq): ?>
            <tr><td><?= $eq['name'] ?></td><td><?= $eq['stock'] ?></td></tr>
        <?php endforeach; ?>
    <?php else: ?>
        <tr><td colspan="2">No equipment with low stock.</td></tr>
    <?php endif; ?>
</table>

<!-- Rental History Report -->
<h2>Rental History Report</h2>
<table>
    <tr><th>Client</th><th>Equipment</th><th>Quantity</th><th>Value</th><th>Start Date</th><th>End Date</th><th>Status</th></tr>
    <?php foreach ($all_rentals as $rental): ?>
        <tr>
            <td><?= $rental['client_name'] ?></td>
            <td><?= $rental['equipment_name'] ?></td>
            <td><?= $rental['quantity'] ?></td>
            <td><?= $rental['value'] ?></td>
            <td><?= $rental['start_date'] ?></td>
            <td><?= $rental['end_date'] ?></td>
            <td><?= $rental['status'] ?></td>
        </tr>
    <?php endforeach; ?>
</table>

<!-- Form to add equipment -->
<h2>Manage Equipments</h2>
<form method="POST">
    <input type="text" name="equipment_name" placeholder="New Equipment Name" required>
    <input type="number" name="equipment_stock" placeholder="Initial Stock" required>
    <button type="submit" name="add_equipment">Add Equipment</button>
</form>
<form method="POST">
    <select name="equipment_id">
        <?php foreach ($equipments as $eq): ?>
            <option value="<?= $eq['id'] ?>"><?= $eq['name'] ?></option>
        <?php endforeach; ?>
    </select>
    <button type="submit" name="remove_equipment">Remove Equipment</button>
</form>

<!-- Form to update stock -->
<h2>Update Stock</h2>
<form method="POST">
    <select name="equipment_id">
        <?php foreach ($equipments as $eq): ?>
            <option value="<?= $eq['id'] ?>"><?= $eq['name'] ?> (Current: <?= $eq['stock'] ?>)</option>
        <?php endforeach; ?>
    </select>
    <input type="number" name="new_stock" placeholder="New Stock Quantity" required>
    <button type="submit" name="update_stock">Update Stock</button>
</form>

<!-- Form to add client -->
<h2>Add Client</h2>
<form method="POST">
    <input type="text" name="client_name" placeholder="Client Name" required>
    <input type="text" name="client_cpf" placeholder="CPF (000.000.000-00)" required>
    <textarea name="client_address" placeholder="Address" required></textarea>
    <button type="submit" name="add_client">Add Client</button>
</form>

<!-- Form to create rental -->
<h2>Create Rental</h2>
<form method="POST">
    <select name="client_id" required>
        <option value="">Select Client</option>
        <?php foreach ($clients as $cl): ?>
            <option value="<?= $cl['id'] ?>"><?= $cl['name'] ?> (CPF: <?= $cl['cpf'] ?>)</option>
        <?php endforeach; ?>
    </select>
    <select name="equipment_id" required>
        <option value="">Select Equipment</option>
        <?php foreach ($equipments as $eq): ?>
            <option value="<?= $eq['id'] ?>"><?= $eq['name'] ?> (Available: <?= $eq['stock'] ?>)</option>
        <?php endforeach; ?>
    </select>
    <input type="number" name="quantity" placeholder="Quantity" required>
    <input type="number" step="0.01" name="value" placeholder="Value" required>
    <input type="date" name="start_date" required>
    <input type="date" name="end_date" required>
    <button type="submit" name="create_rental">Save Rental</button>
</form>

<!-- Active Rentals -->
<h2>Active Rentals</h2>
<table>
    <tr><th>Client</th><th>Equipment</th><th>Quantity</th><th>Value</th><th>Start Date</th><th>End Date</th><th>Action</th></tr>
    <?php foreach ($rentals as $rental): ?>
        <tr>
            <td><?= $rental['client_name'] ?></td>
            <td><?= $rental['equipment_name'] ?></td>
            <td><?= $rental['quantity'] ?></td>
            <td><?= $rental['value'] ?></td>
            <td><?= $rental['start_date'] ?></td>
            <td><?= $rental['end_date'] ?></td>
            <td>
                <form method="POST">
                    <input type="hidden" name="rental_id" value="<?= $rental['id'] ?>">
                    <input type="hidden" name="equipment_id" value="<?= $rental['equipment_id'] ?>">
                    <input type="hidden" name="quantity" value="<?= $rental['quantity'] ?>">
                    <button type="submit" name="complete_rental">Complete Rental</button>
                </form>
            </td>
        </tr>
    <?php endforeach; ?>
</table>

<!-- For registration (optional) -->
<h2>Register User (for admin)</h2>
<form method="POST">
    <input type="text" name="username" placeholder="Username" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit" name="register">Register</button>
</form>

</body>
</html>